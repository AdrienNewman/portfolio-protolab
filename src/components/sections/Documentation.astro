---
// Documentation Section Component
import { getCollection } from 'astro:content';
import { getIconPath, getIconColor } from '../../utils/icons';
import { CATEGORY_CONFIG } from '../../utils/categoryMapping';

// Fetch toutes les documentations
const allDocs = await getCollection('docs');

// Trier par date (plus récent d'abord)
const sortedDocs = allDocs.sort((a, b) =>
  b.data.date.getTime() - a.data.date.getTime()
);

// Grouper par catégorie
const docsByCategory = sortedDocs.reduce((acc, doc) => {
  const cat = doc.data.category;
  if (!acc[cat]) acc[cat] = [];
  acc[cat].push(doc);
  return acc;
}, {} as Record<string, typeof allDocs>);

// Calculer statistiques réelles
const totalDocs = allDocs.length;
const totalWords = allDocs.reduce((sum, doc) => {
  return sum + doc.body.split(/\s+/).length;
}, 0);
const estimatedHours = Math.round(totalDocs * 3);
const allTags = [...new Set(allDocs.flatMap(d => d.data.tags || []))];
const techCount = allTags.length;

// Préparer les icônes pour les stats hero
const iconFile = getIconPath('file');
const iconDocument = getIconPath('document');
const iconClock = getIconPath('clock');
const iconCode = getIconPath('code');

// Regrouper les docs par mois pour la timeline
const docsByMonth = sortedDocs.reduce((acc, doc) => {
    const monthKey = doc.data.date.toLocaleDateString('fr-FR', {
        month: 'long',
        year: 'numeric'
    });
    if (!acc[monthKey]) {
        acc[monthKey] = [];
    }
    acc[monthKey].push(doc);
    return acc;
}, {} as Record<string, typeof sortedDocs>);

// Trier les mois par date décroissante
const sortedMonths = Object.entries(docsByMonth).sort((a, b) => {
    const dateA = new Date(a[1][0].data.date);
    const dateB = new Date(b[1][0].data.date);
    return dateB.getTime() - dateA.getTime();
});
---

<section class="section doc-section" id="documentation">
    <div class="doc-container">
        <div class="section-header">
            <span class="section-label">Documentation_PROTOLAB</span>
            <h2 class="section-title">Mon <span>Catalogue</span> Technique</h2>
            <p class="section-desc">{totalDocs} documents techniques couvrant l'ensemble de l'infrastructure Protolab.</p>
        </div>

        <!-- Stats Hero -->
        <div class="doc-stats-hero">
            <div class="doc-stat-card">
                <div class="doc-stat-icon">
                    <svg viewBox="0 0 24 24" fill="#00ffff"><path d={iconFile} /></svg>
                </div>
                <div class="doc-stat-value" data-count={totalDocs}>0</div>
                <div class="doc-stat-label">Documents</div>
            </div>
            <div class="doc-stat-card">
                <div class="doc-stat-icon">
                    <svg viewBox="0 0 24 24" fill="#ff0080"><path d={iconDocument} /></svg>
                </div>
                <div class="doc-stat-value" data-count={Math.floor(totalWords / 1000)} data-suffix="K">0</div>
                <div class="doc-stat-label">Mots écrits</div>
            </div>
            <div class="doc-stat-card">
                <div class="doc-stat-icon">
                    <svg viewBox="0 0 24 24" fill="#00ff88"><path d={iconClock} /></svg>
                </div>
                <div class="doc-stat-value" data-count={estimatedHours} data-prefix="+">0</div>
                <div class="doc-stat-label">Heures de travail</div>
            </div>
            <div class="doc-stat-card">
                <div class="doc-stat-icon">
                    <svg viewBox="0 0 24 24" fill="#ffcc00"><path d={iconCode} /></svg>
                </div>
                <div class="doc-stat-value" data-count={techCount} data-prefix="+">0</div>
                <div class="doc-stat-label">Technologies</div>
            </div>
        </div>

        <!-- Categories Grid -->
        <div class="doc-categories">
            <div class="doc-categories-header">
                <h3 class="doc-categories-title">Catégories <span>Documentées</span></h3>
                <span class="doc-filter-info">// {Object.keys(docsByCategory).length} catégories • Cliquez pour filtrer</span>
            </div>
            <div class="doc-categories-grid">
                {Object.entries(CATEGORY_CONFIG).map(([catKey, catInfo]) => {
                    const docCount = docsByCategory[catKey]?.length || 0;
                    if (docCount === 0) return null; // Skip catégories vides

                    return (
                        <div class="doc-category-card" style={`--category-color: ${catInfo.color};`} data-category={catKey}>
                            <div class="doc-category-icon">
                                <svg viewBox="0 0 24 24" fill={catInfo.color}>
                                    <path d={getIconPath(catInfo.icon)} />
                                </svg>
                            </div>
                            <div class="doc-category-name">{catInfo.displayName}</div>
                            <div class="doc-category-count">{docCount} doc{docCount > 1 ? 's' : ''}</div>
                        </div>
                    );
                })}
            </div>
        </div>

        <!-- Timeline -->
        <div class="doc-timeline">
            <div class="doc-timeline-header">
                <h3 class="doc-timeline-title">Timeline <span>du Projet</span></h3>
            </div>
            <div class="doc-timeline-container">
                {sortedMonths.map(([monthKey, docs]) => (
                    <div class="doc-timeline-month">
                        <div class="doc-timeline-month-title">{monthKey.charAt(0).toUpperCase() + monthKey.slice(1)}</div>
                        <div class="doc-timeline-items">
                            {docs.slice(0, 3).map(doc => {
                                const categoryInfo = CATEGORY_CONFIG[doc.data.category as keyof typeof CATEGORY_CONFIG];
                                return (
                                    <div class="doc-timeline-item">
                                        <div class="doc-timeline-item-icon">
                                            <svg viewBox="0 0 24 24" fill={categoryInfo.color}>
                                                <path d={getIconPath(categoryInfo.icon)} />
                                            </svg>
                                        </div>
                                        <div class="doc-timeline-item-content">
                                            <div class="doc-timeline-item-title">{doc.data.title}</div>
                                            <div class="doc-timeline-item-meta">
                                                {categoryInfo.displayName}
                                                <span class="doc-timeline-item-type">MD</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                ))}
            </div>
        </div>

        <!-- Liste des documentations réelles -->
        <div class="doc-list-section">
            <div class="doc-list-header">
                <h3 class="doc-list-title">Documentations <span>Disponibles</span></h3>
                <p class="doc-list-desc">Cliquez sur une documentation pour la consulter</p>
            </div>
            <div class="doc-list-grid">
                {sortedDocs.map(doc => {
                    const categoryInfo = CATEGORY_CONFIG[doc.data.category];
                    return (
                        <div class="doc-list-card" data-doc-slug={doc.slug}>
                            <div class="doc-card-header">
                                <span class="doc-card-category" style={`--cat-color: ${categoryInfo.color}`}>
                                    {categoryInfo.displayName}
                                </span>
                                <span class="doc-card-date">
                                    {doc.data.date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' })}
                                </span>
                            </div>
                            <h4 class="doc-card-title">{doc.data.title}</h4>
                            <p class="doc-card-description">{doc.data.description}</p>
                            {doc.data.tags && doc.data.tags.length > 0 && (
                                <div class="doc-card-tags">
                                    {doc.data.tags.slice(0, 3).map(tag => (
                                        <span class="doc-card-tag">{tag}</span>
                                    ))}
                                    {doc.data.tags.length > 3 && (
                                        <span class="doc-card-tag-more">+{doc.data.tags.length - 3}</span>
                                    )}
                                </div>
                            )}
                        </div>
                    );
                })}
            </div>
        </div>
    </div>
</section>

<style>
    .section { position: relative; z-index: 1; padding: 8rem 2rem; }

    .doc-section {
        background: transparent;
        position: relative;
        overflow: hidden;
    }

    .doc-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background:
            radial-gradient(ellipse at 20% 20%, rgba(0, 255, 255, 0.03) 0%, transparent 50%),
            radial-gradient(ellipse at 80% 80%, rgba(255, 0, 128, 0.03) 0%, transparent 50%);
        pointer-events: none;
    }

    .doc-container {
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
        z-index: 1;
    }

    .section-header { text-align: center; margin-bottom: 5rem; }

    .section-label {
        display: inline-block;
        font-family: 'Space Mono', monospace;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        color: var(--neon-cyan);
        margin-bottom: 1rem;
        padding: 0.5rem 1rem;
        border: 1px solid var(--neon-cyan);
        opacity: 0;
        transform: translateY(20px);
    }

    .section-title {
        font-family: 'Bebas Neue', sans-serif;
        font-size: clamp(3rem, 8vw, 6rem);
        letter-spacing: 0.02em;
        line-height: 1;
        margin-bottom: 1.5rem;
        opacity: 0;
        transform: translateY(30px);
    }

    .section-title span { color: var(--neon-cyan); }

    .section-desc {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 1.2rem;
        color: var(--gray-light);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.4;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        opacity: 0;
        transform: translateY(20px);
    }

    /* Documentation Stats Hero */
    .doc-stats-hero {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 4rem;
        padding: 2rem;
        background: rgba(26, 26, 26, 0.5);
        border: 1px solid var(--gray-mid);
        position: relative;
    }

    .doc-stats-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta), var(--neon-green));
    }

    .doc-stat-card {
        text-align: center;
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--gray-mid);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .doc-stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.05), transparent);
        transition: left 0.5s ease;
    }

    .doc-stat-card:hover::before {
        left: 100%;
    }

    .doc-stat-card:hover {
        border-color: var(--neon-cyan);
        transform: translateY(-5px);
    }

    .doc-stat-value {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 3.5rem;
        color: var(--neon-cyan);
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .doc-stat-card:nth-child(2) .doc-stat-value { color: var(--neon-magenta); }
    .doc-stat-card:nth-child(3) .doc-stat-value { color: var(--neon-green); }
    .doc-stat-card:nth-child(4) .doc-stat-value { color: var(--neon-yellow); }

    .doc-stat-label {
        font-family: 'Space Mono', monospace;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--gray-light);
    }

    .doc-stat-icon {
        width: 32px;
        height: 32px;
        margin: 0 auto 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .doc-stat-icon svg {
        width: 100%;
        height: 100%;
    }

    /* Categories Grid */
    .doc-categories {
        margin-bottom: 4rem;
    }

    .doc-categories-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .doc-categories-title {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 1.5rem;
        letter-spacing: 0.05em;
        color: var(--white);
    }

    .doc-categories-title span {
        color: var(--neon-cyan);
    }

    .doc-filter-info {
        font-size: 0.75rem;
        color: var(--gray-light);
        font-family: 'JetBrains Mono', monospace;
    }

    .doc-categories-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1rem;
    }

    .doc-category-card {
        background: var(--gray-mid);
        border: 2px solid var(--gray-mid);
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .doc-category-card::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: var(--category-color, var(--neon-cyan));
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
    }

    .doc-category-card:hover::before,
    .doc-category-card.active::before {
        transform: scaleX(1);
    }

    .doc-category-card:hover,
    .doc-category-card.active {
        border-color: var(--category-color, var(--neon-cyan));
        background: rgba(0, 255, 255, 0.05);
    }

    .doc-category-icon {
        width: 32px;
        height: 32px;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .doc-category-icon svg {
        width: 100%;
        height: 100%;
    }

    .doc-category-name {
        font-family: 'Space Mono', monospace;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--white);
        margin-bottom: 0.25rem;
    }

    .doc-category-count {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        color: var(--category-color, var(--neon-cyan));
        font-weight: 700;
    }

    /* Timeline Section */
    .doc-timeline {
        margin-bottom: 4rem;
    }

    .doc-timeline-header {
        margin-bottom: 2rem;
    }

    .doc-timeline-title {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 1.5rem;
        letter-spacing: 0.05em;
        color: var(--white);
    }

    .doc-timeline-title span {
        color: var(--neon-magenta);
    }

    .doc-timeline-container {
        position: relative;
        padding-left: 3rem;
    }

    .doc-timeline-container::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(180deg, var(--neon-cyan), var(--neon-magenta), var(--neon-green));
    }

    .doc-timeline-month {
        position: relative;
        margin-bottom: 2rem;
    }

    .doc-timeline-month::before {
        content: '';
        position: absolute;
        left: -3rem;
        top: 0.5rem;
        width: 12px;
        height: 12px;
        background: var(--neon-cyan);
        border-radius: 50%;
        box-shadow: 0 0 20px var(--neon-cyan);
    }

    .doc-timeline-month:nth-child(2)::before {
        background: var(--neon-magenta);
        box-shadow: 0 0 20px var(--neon-magenta);
    }

    .doc-timeline-month-title {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 1.25rem;
        color: var(--neon-cyan);
        margin-bottom: 1rem;
        letter-spacing: 0.05em;
    }

    .doc-timeline-month:nth-child(2) .doc-timeline-month-title {
        color: var(--neon-magenta);
    }

    .doc-timeline-items {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .doc-timeline-item {
        background: var(--gray-mid);
        border: 1px solid var(--gray-mid);
        padding: 1rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .doc-timeline-item:hover {
        border-color: var(--neon-cyan);
        transform: translateX(5px);
    }

    .doc-timeline-item-icon {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 255, 255, 0.1);
        border: 1px solid rgba(0, 255, 255, 0.3);
        flex-shrink: 0;
        padding: 6px;
    }

    .doc-timeline-item-icon svg {
        width: 100%;
        height: 100%;
    }

    .doc-timeline-item-content {
        flex: 1;
        min-width: 0;
    }

    .doc-timeline-item-title {
        font-family: 'Space Mono', monospace;
        font-size: 0.75rem;
        color: var(--white);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 0.25rem;
    }

    .doc-timeline-item-meta {
        font-size: 0.65rem;
        color: var(--gray-light);
    }

    .doc-timeline-item-type {
        display: inline-block;
        padding: 0.15rem 0.4rem;
        background: rgba(0, 255, 255, 0.1);
        border: 1px solid rgba(0, 255, 255, 0.3);
        font-size: 0.6rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--neon-cyan);
        margin-left: 0.5rem;
    }

    .doc-timeline-item-type.pdf {
        background: rgba(255, 0, 128, 0.1);
        border-color: rgba(255, 0, 128, 0.3);
        color: var(--neon-magenta);
    }

    /* Documentation List Section */
    .doc-list-section {
        margin-top: 4rem;
        padding-top: 4rem;
        border-top: 1px solid var(--gray-mid);
    }

    .doc-list-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .doc-list-title {
        font-family: 'Bebas Neue', sans-serif;
        font-size: 2.5rem;
        letter-spacing: 0.05em;
        color: var(--white);
        margin-bottom: 0.5rem;
    }

    .doc-list-title span {
        color: var(--neon-cyan);
    }

    .doc-list-desc {
        font-size: 0.9rem;
        color: var(--gray-light);
    }

    .doc-list-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .doc-list-card {
        background: rgba(26, 26, 26, 0.5);
        border: 1px solid var(--gray-mid);
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .doc-list-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, var(--neon-cyan), var(--neon-magenta));
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
    }

    .doc-list-card:hover::before {
        transform: scaleX(1);
    }

    .doc-list-card:hover {
        border-color: var(--neon-cyan);
        background: rgba(0, 255, 255, 0.03);
        transform: translateY(-3px);
    }

    .doc-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .doc-card-category {
        font-family: 'Space Mono', monospace;
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--cat-color, var(--neon-cyan));
        background: rgba(255, 255, 255, 0.05);
        padding: 0.25rem 0.5rem;
        border: 1px solid currentColor;
    }

    .doc-card-date {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.7rem;
        color: var(--gray-light);
    }

    .doc-card-title {
        font-family: 'Space Mono', monospace;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--white);
        margin-bottom: 0.75rem;
        line-height: 1.4;
    }

    .doc-card-description {
        font-size: 0.85rem;
        color: var(--gray-light);
        line-height: 1.6;
        margin-bottom: 1rem;
    }

    .doc-card-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .doc-card-tag {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.65rem;
        color: var(--neon-cyan);
        background: rgba(0, 255, 255, 0.1);
        border: 1px solid rgba(0, 255, 255, 0.3);
        padding: 0.2rem 0.5rem;
    }

    .doc-card-tag-more {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.65rem;
        color: var(--gray-light);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--gray-mid);
        padding: 0.2rem 0.5rem;
    }

    /* Responsive */
    @media (max-width: 968px) {
        .doc-stats-hero {
            grid-template-columns: repeat(2, 1fr);
        }
        .doc-categories-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        .doc-timeline-items {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .section { padding: 5rem 1rem; }
        .section-header { margin-bottom: 3rem; }

        .doc-stats-hero {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .doc-stat-value {
            font-size: 2.5rem;
        }
        .doc-categories-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        .doc-timeline-container {
            padding-left: 2rem;
        }
        .doc-timeline-month::before {
            left: -2rem;
        }

        /* Fix overflow doc cards */
        .doc-list-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .doc-list-card {
            max-width: 100%;
            overflow: hidden;
        }

        .doc-card-title {
            font-size: 1rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .doc-card-desc {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 480px) {
        .section { padding: 4rem 0.75rem; }

        .doc-categories-grid {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .doc-list-card {
            padding: 1rem;
        }

        .doc-card-title {
            font-size: 0.9rem;
        }
    }
</style>
